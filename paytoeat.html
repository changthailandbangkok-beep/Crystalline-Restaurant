<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ชำระเงินค่าอาหาร</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            background: #fff;
            color: #0a0100;
        }
        .container {
            max-width: 400px;
            margin: 40px auto;
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px #ccc;
        }
        h2 { text-align: center; }
        label { display: block; margin-top: 16px; }
        input[type="text"], input[type="number"], input[type="month"] {
            width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px;
        }
        button { margin-top: 24px; width: 100%; padding: 12px; background: #c0392b; color: #fff; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        button:hover { background: #a93226; }
        .success { color: green; text-align: center; margin-top: 16px; }
        .error { color: red; text-align: center; margin-top: 16px; }
        .tip-btn.active-tip {
            background: #c0392b;
            color: #fff;
            border-color: #c0392b;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header Section -->
    <header class="bg-[#c0392b] shadow-sm py-4 px-6 md:px-12 flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <a href="index.html" class="text-2xl font-bold text-white">Crystalline Restaurant</a>
            <nav class="hidden md:flex space-x-6 text-white">
                <a href="index.html" class="hover:text-[#ffe5e0] transition-colors">หน้าแรก</a>
                <a href="#" class="hover:text-[#ffe5e0] transition-colors">สินค้า</a>
                <a href="#" class="hover:text-[#ffe5e0] transition-colors">บทความ</a>
                <a href="index010.html" class="hover:text-[#ffe5e0] transition-colors">ติดต่อเรา</a>
            </nav>
        </div>
        <div class="flex items-center space-x-4">
            <a href="lookin01.html" id="login-btn" class="text-white hover:text-[#ffe5e0] transition-colors flex items-center">
                <i class="fas fa-user mr-1"></i> เข้าสู่ระบบ
            </a>
            <button id="logout-btn" class="bg-white text-[#c0392b] px-4 py-2 rounded-full hover:bg-[#c0392b] hover:text-white border-2 border-white transition-colors flex items-center" style="display:none;">
                <i class="fas fa-sign-out-alt mr-2"></i> ออกจากระบบ
            </button>
            <a href="index01.html" class="bg-white text-[#c0392b] px-4 py-2 rounded-full hover:bg-[#c0392b] hover:text-white border-2 border-white transition-colors flex items-center relative">
                <i class="fas fa-shopping-cart mr-2"></i> ตะกร้า
                <span id="cart-count-badge" class="absolute -top-2 -right-2 bg-[#c0392b] text-white text-xs font-bold px-2 py-0.5 rounded-full border border-white">0</span>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex items-center justify-center bg-[#f7f7f7] py-8">
        <div class="container flex flex-col md:flex-row gap-8">
            <!-- ใบเสร็จอยู่ด้านซ้าย -->
            <div class="w-full md:w-1/2">
                <h2 class="text-2xl font-bold text-[#c0392b] mb-4">ชำระเงินค่าอาหาร</h2>
                <div id="bill" class="mb-6 bg-[#f9f9f9] p-4 rounded-lg shadow">
                    <h3 class="text-left text-lg font-semibold mb-3 text-[#c0392b]">ใบเสร็จรายการอาหาร</h3>
                    <div id="bill-items"></div>
                    <div class="text-right font-bold mt-3">
                        ยอดรวมทั้งหมด: <span id="bill-total">฿ 0.00</span>
                    </div>
                </div>
            </div>
            <!-- ฟอร์มชำระเงินอยู่ด้านขวา -->
            <div class="w-full md:w-1/2 flex flex-col justify-center">
                <form id="paymentForm">
                    <label>ช่องทางการชำระเงิน</label>
                    <select id="paymentMethod" class="mb-4 w-full p-2 border border-gray-300 rounded" required>
                        <option value="qr">QR PromptPay</option>
                        <option value="cash">เงินสด</option>
                    </select>

                    <div id="qr-fields">
                        <div class="mb-4 text-center">
                            <img src="ดาวน์โหลด.jpg" alt="QR PromptPay" style="max-width:260px;width:100%;margin:auto;">
                            <div class="mt-2 text-[#c0392b] font-semibold">สแกน QR เพื่อโอนเงินผ่าน PromptPay</div>
                            <div class="text-gray-700 text-sm mt-1">ชื่อ: นาย ฐีรภาสกร จุลพันธ์<br>บัญชี: xxx-x-x7838-x</div>
                        </div>
                    </div>

                    <div id="cash-fields" style="display:none;">
                        <p class="mb-2 text-[#c0392b] font-semibold">กรุณาชำระเงินสดที่ร้านเมื่อรับอาหาร</p>
                    </div>

                    <label>จำนวนเงิน (บาท)</label>
                    <input type="number" id="amount" min="1" required readonly style="background:#f3f3f3;">

                    <button type="submit">ชำระเงิน</button>
                </form>
                <div id="message"></div>
            </div>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-black text-white py-10 px-6 md:px-12 mt-auto border-t border-black">
      <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-10">
        <div>
          <h3 class="text-2xl font-extrabold mb-4 text-[#c0392b] tracking-wide">Crystalline Restaurant</h3>
          <p class="text-white text-base leading-relaxed">
            ร้านอาหารสุดหรูสำหรับทุกโอกาส
          </p>
        </div>
        <div>
          <h3 class="text-xl font-semibold mb-4 text-[#c0392b]">ลิงก์ด่วน</h3>
          <ul class="space-y-2 text-base">
            <li><a href="index.html" class="hover:underline hover:text-[#c0392b]">หน้าแรก</a></li>
            <li><a href="#" class="hover:underline hover:text-[#c0392b]">สินค้า</a></li>
            <li><a href="#" class="hover:underline hover:text-[#c0392b]">บทความ</a></li>
            <li><a href="index010.html" class="hover:underline hover:text-[#c0392b]">ติดต่อเรา</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-xl font-semibold mb-4 text-[#c0392b]">ติดต่อเรา</h3>
          <p class="text-white text-base">
            โทร: 02-123-4567<br>
            อีเมล: info@crystalline.com
          </p>
          <div class="flex space-x-4 mt-5">
            <a href="#" class="text-white hover:text-[#c0392b]"><i class="fab fa-facebook fa-lg"></i></a>
            <a href="#" class="text-white hover:text-[#c0392b]"><i class="fab fa-instagram fa-lg"></i></a>
            <a href="#" class="text-white hover:text-[#c0392b]"><i class="fab fa-line fa-lg"></i></a>
          </div>
        </div>
      </div>
      <div class="text-center text-white text-sm mt-10 pt-6 border-t border-black">
        &copy; 2025 <span class="text-white font-semibold">Crystalline Restaurant</span>. All rights reserved.
      </div>
    </footer>

    <script>
        // ดึงข้อมูลตะกร้าจาก localStorage
        let billTotal = 0;

        function renderBill() {
            const billItemsDiv = document.getElementById('bill-items');
            const billTotalSpan = document.getElementById('bill-total');
            let cart = JSON.parse(localStorage.getItem('razorhub_cart')) || [];
            billTotal = 0;
            if (cart.length === 0) {
                billItemsDiv.innerHTML = '<div class="text-center text-gray-500">ไม่มีรายการอาหารในตะกร้า</div>';
                billTotalSpan.textContent = '฿ 0.00';
                document.getElementById('amount').value = 0;
                return;
            }
            let html = '<table class="w-full text-sm"><thead><tr><th class="text-left">ชื่ออาหาร</th><th class="text-center">จำนวน</th><th class="text-right">ราคา</th></tr></thead><tbody>';
            cart.forEach(item => {
                html += `<tr>
                    <td>${item.name}</td>
                    <td class="text-center">${item.quantity}</td>
                    <td class="text-right">฿ ${(item.price * item.quantity).toFixed(2)}</td>
                </tr>`;
                billTotal += item.price * item.quantity;
            });
            html += '</tbody></table>';
            billItemsDiv.innerHTML = html;
            billTotalSpan.textContent = `฿ ${billTotal.toFixed(2)}`;
            document.getElementById('amount').value = billTotal.toFixed(2);

            // อัปเดต badge จำนวนสินค้า
            const badge = document.getElementById('cart-count-badge');
            const totalCount = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
            badge.textContent = totalCount;
            badge.style.display = totalCount > 0 ? 'inline-block' : 'none';
        }

        // แสดงบิลเมื่อโหลดหน้า
        window.onload = renderBill;

        // เปลี่ยนช่องทางการชำระเงิน
        document.getElementById('paymentMethod').addEventListener('change', function() {
            const method = this.value;
            document.getElementById('qr-fields').style.display = method === 'qr' ? 'block' : 'none';
            document.getElementById('cash-fields').style.display = method === 'cash' ? 'block' : 'none';
            document.getElementById('qrRef').required = method === 'qr';
        });

        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const method = document.getElementById('paymentMethod').value;
            const amount = document.getElementById('amount').value;
            const message = document.getElementById('message');
            let user = firebase.auth().currentUser;
            let cart = JSON.parse(localStorage.getItem('razorhub_cart')) || [];

            if(amount <= 0) {
                message.innerHTML = '<div class="error">กรุณากรอกจำนวนเงินที่ถูกต้อง</div>';
                return;
            }

            let paymentData = {
                uid: user ? user.uid : null,
                email: user ? user.email : null,
                method,
                amount: parseFloat(amount),
                cart,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            // ไม่ต้องตรวจสอบเลขอ้างอิง

            try {
                const docRef = await db.collection('payments').add(paymentData);
                localStorage.removeItem('razorhub_cart');
                document.getElementById('cart-count-badge').textContent = '0';
                window.location.href = `billreceipt.html?paymentId=${docRef.id}`;
            } catch (err) {
                message.innerHTML = '<div class="error">เกิดข้อผิดพลาดในการบันทึกข้อมูล กรุณาลองใหม่อีกครั้ง</div>';
            }
        });
    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <!-- เพิ่ม Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase config (ใช้ชุดเดียวกับ index01.html)
        const firebaseConfig = {
            apiKey: "AIzaSyD60lZDB8Qk-kl2GUL-_NK7JItML9S-TEc",
            authDomain: "crystalline-restaurant.firebaseapp.com",
            projectId: "crystalline-restaurant",
            storageBucket: "crystalline-restaurant.firebasestorage.app",
            messagingSenderId: "637558385298",
            appId: "1:637558385298:web:ac380bfdabebb69009544b",
            measurementId: "G-4RVP21DGJY"
        };
        firebase.initializeApp(firebaseConfig);

        // สร้าง Firestore instance
        const db = firebase.firestore();

        // แสดง/ซ่อนปุ่ม login/logout ตามสถานะผู้ใช้
        firebase.auth().onAuthStateChanged(function(user) {
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            if (user) {
                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'flex';
            } else {
                if (loginBtn) loginBtn.style.display = 'flex';
                if (logoutBtn) logoutBtn.style.display = 'none';
            }
        });

        // ฟังก์ชัน logout
        document.getElementById('logout-btn').addEventListener('click', function() {
            firebase.auth().signOut().then(function() {
                window.location.reload();
            });
        });
    </script>
</body>
</html>