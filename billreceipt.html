<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ใบเสร็จการชำระเงิน</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', Arial, sans-serif; background: #f7f7f7; }
        .container { max-width: 600px; margin: 40px auto; background: #fff; padding: 40px 32px; border-radius: 16px; box-shadow: 0 4px 16px #c0392b33; }
        h2 { text-align: center; color: #c0392b; font-size: 2.5rem; font-weight: 700; margin-bottom: 1.5rem; }
        .label { color: #c0392b; font-weight: 600; font-size: 1.2rem; }
        .value { color: #222; font-size: 1.2rem; }
        .success { color: green; text-align: center; margin-bottom: 16px; font-size: 1.3rem; font-weight: 600; }
        #receipt { font-size: 1.18rem; }
        table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
        table th, table td { font-size: 1.15rem; padding: 10px 6px; }
        table th { background: #ffe5e0; color: #c0392b; font-weight: 600; }
        table tr:nth-child(even) { background: #f7f7f7; }
        .receipt-section { margin-bottom: 1.2rem; }
        .receipt-divider { border-bottom: 2px solid #c0392b22; margin: 1.2rem 0; }
        .text-center { text-align: center; }
        .receipt-id { background: #c0392b; color: #fff; padding: 6px 16px; border-radius: 999px; font-size: 1.1rem; display: inline-block; margin-bottom: 1rem; }
        .back-btn { margin-top: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ใบเสร็จการชำระเงิน</h2>
        <div id="successMsg" class="success"></div>
        <div id="receipt"></div>
        <div class="text-center back-btn">
            <a href="index.html" class="bg-[#c0392b] text-white px-7 py-3 rounded-full hover:bg-[#a93226] transition font-semibold text-lg shadow">กลับหน้าแรก</a>
        </div>
    </div>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase config (ใช้ชุดเดียวกับ paytoeat.html)
        const firebaseConfig = {
            apiKey: "AIzaSyD60lZDB8Qk-kl2GUL-_NK7JItML9S-TEc",
            authDomain: "crystalline-restaurant.firebaseapp.com",
            projectId: "crystalline-restaurant",
            storageBucket: "crystalline-restaurant.firebasestorage.app",
            messagingSenderId: "637558385298",
            appId: "1:637558385298:web:ac380bfdabebb69009544b",
            measurementId: "G-4RVP21DGJY"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // รับ paymentId จาก query string
        function getPaymentId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('paymentId');
        }

        async function renderReceipt() {
            const paymentId = getPaymentId();
            const receiptDiv = document.getElementById('receipt');
            const successMsg = document.getElementById('successMsg');
            if (!paymentId) {
                receiptDiv.innerHTML = '<div class="text-red-600 text-center">ไม่พบข้อมูลใบเสร็จ</div>';
                return;
            }
            try {
                const doc = await db.collection('payments').doc(paymentId).get();
                if (!doc.exists) {
                    receiptDiv.innerHTML = '<div class="text-red-600 text-center">ไม่พบข้อมูลใบเสร็จ</div>';
                    return;
                }
                const data = doc.data();
                successMsg.textContent = "✅ ชำระเงินสำเร็จ ขอบคุณค่ะ!";
                let html = `
                    <div class="text-center receipt-id">หมายเลขใบเสร็จ: ${doc.id}</div>
                    <div class="receipt-section">
                        <span class="label">วันที่:</span>
                        <span class="value">${data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().toLocaleString('th-TH') : '-'}</span>
                    </div>
                    <div class="receipt-section">
                        <span class="label">ช่องทางชำระเงิน:</span>
                        <span class="value">
                            ${data.method === 'qr' ? 'QR PromptPay' : data.method === 'cash' ? 'เงินสด' : '-'}
                        </span>
                    </div>
                    ${data.method === 'card' ? `
                        <div class="receipt-section">
                            <span class="label">ชื่อบนบัตร:</span>
                            <span class="value">${data.cardName || '-'}</span>
                        </div>
                        <div class="receipt-section">
                            <span class="label">หมายเลขบัตร:</span>
                            <span class="value">${data.cardNumber || '-'}</span>
                        </div>
                    ` : ''}
                    ${data.method === 'bank' ? `
                        <div class="receipt-section">
                            <span class="label">ธนาคาร:</span>
                            <span class="value">${data.bankName || '-'}</span>
                        </div>
                        <div class="receipt-section">
                            <span class="label">เลขที่บัญชี:</span>
                            <span class="value">${data.bankAccount || '-'}</span>
                        </div>
                        <div class="receipt-section">
                            <span class="label">ชื่อผู้โอน:</span>
                            <span class="value">${data.bankSender || '-'}</span>
                        </div>
                    ` : ''}
                    <div class="receipt-section">
                        <span class="label">จำนวนเงิน:</span>
                        <span class="value">฿ ${data.amount ? data.amount.toFixed(2) : '-'}</span>
                    </div>
                    <div class="receipt-divider"></div>
                    <div class="label mb-2">รายการอาหาร</div>
                    <table>
                        <thead>
                            <tr>
                                <th class="text-left">ชื่ออาหาร</th>
                                <th class="text-center">จำนวน</th>
                                <th class="text-right">ราคา</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Array.isArray(data.cart) && data.cart.length > 0 ? data.cart.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td class="text-center">${item.quantity}</td>
                                    <td class="text-right">฿ ${(item.price * item.quantity).toFixed(2)}</td>
                                </tr>
                            `).join('') : `<tr><td colspan="3" class="text-center text-gray-400">ไม่มีข้อมูลอาหาร</td></tr>`}
                        </tbody>
                    </table>
                `;
                receiptDiv.innerHTML = html;
            } catch (err) {
                receiptDiv.innerHTML = '<div class="text-red-600 text-center">เกิดข้อผิดพลาดในการโหลดใบเสร็จ</div>';
            }
        }

        window.onload = renderReceipt;
    </script>
</body>
</html>